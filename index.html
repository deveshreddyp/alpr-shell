<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPR with YOLO & Tesseract</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark gray */
            color: #d1d5db; /* Light gray text */
        }
        .pipeline-step {
            background-color: #1f2937; /* Lighter dark */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #374151;
        }
        .step-title {
            color: #9ca3af;
            font-weight: 600;
            border-bottom: 1px solid #374151;
            padding-bottom: 0.75rem;
        }
        .pending-box {
            background-color: #374151; /* Medium dark */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 256px; /* 16rem */
            border-radius: 0.375rem;
            color: #9ca3af;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6; /* Blue */
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .btn-success {
            background-color: #16a34a;
            color: white;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        img {
            object-fit: contain;
            width: 100%;
            height: 100%;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Automated License Plate Recognition</h1>
            <p class="text-lg text-gray-400">Running on a Python + Flask + YOLOv8 + Tesseract backend</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Column 1: Input -->
            <div class="md:col-span-1 space-y-6">
                <div class="pipeline-step p-5">
                    <h2 class="step-title mb-4">1. Load Image</h2>
                    <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-600 file:text-white
                        hover:file:bg-blue-700 cursor-pointer">
                </div>

                <div class="pipeline-step p-5">
                    <h2 class="step-title mb-4">Uploaded Image</h2>
                    <div id="uploadPreview" class="pending-box">
                        <span class="text-sm">Upload an image to start</span>
                    </div>
                </div>

                <button id="runButton" class="w-full text-lg font-bold py-3 px-6 rounded-lg btn-primary transition-all duration-200"
                    onclick="runPipeline()">
                    Run ML Pipeline
                </button>
                <div id="statusMessage" class="text-center p-3 rounded-lg hidden"></div>
            </div>

            <!-- Column 2: Processing Pipeline -->
            <div class="md:col-span-2 space-y-6">
                <h2 class="text-2xl font-semibold text-white">2. Processing Pipeline</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                    <!-- Step 1: Grayscale -->
                    <div class="pipeline-step p-5">
                        <h2 class="step-title mb-4">Step 1: Grayscale Conversion</h2>
                        <div id="step1Box" class="pending-box">
                            <span class="text-sm">Pending</span>
                        </div>
                    </div>

                    <!-- Step 2: OCR Pre-processing -->
                    <div class="pipeline-step p-5">
                        <h2 class="step-title mb-4">Step 2: OCR Pre-processing (Warped Plate)</h2>
                        <div id="step2Box" class="pending-box">
                            <span class="text-sm">Pending</span>
                        </div>
                    </div>

                    <!-- Step 3: Plate Localization -->
                    <div class="pipeline-step p-5">
                        <h2 class="step-title mb-4">Step 3: Plate Localization (YOLOv8)</h2>
                        <div id="step3Box" class="pending-box">
                            <span class="text-sm">Pending</span>
                        </div>
                    </div>

                    <!-- Step 4: OCR Result -->
                    <div class="pipeline-step p-5">
                        <h2 class="step-title mb-4">Step 4: Recognized Text (Tesseract)</h2>
                        <div id="step4Box" class="pending-box">
                            <textarea id="ocrResult" rows="3" readonly
                                class="w-full bg-gray-900 text-gray-200 text-2xl font-mono p-4 rounded-md border-gray-700"
                                style="display: none; min-height: 100px; resize: none;"></textarea>
                            <span id="step4Pending" class="text-sm">Pending</span>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        let base64Image = null;

        // --- 1. Handle Image Upload ---
        document.getElementById('imageInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // Display preview
                const preview = document.getElementById('uploadPreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Uploaded Image" />`;

                // Store base64 string (without the prefix)
                base64Image = e.target.result.split(',')[1];
                
                // Reset UI
                resetPipelineUI();
            };
            reader.readAsDataURL(file);
        });

        // --- 2. Reset UI ---
        function resetPipelineUI() {
            // Clear result boxes and show 'Pending'
            document.getElementById('step1Box').innerHTML = '<span class="text-sm">Pending</span>';
            document.getElementById('step2Box').innerHTML = '<span class="text-sm">Pending</span>';
            document.getElementById('step3Box').innerHTML = '<span class="text-sm">Pending</span>';
            
            // Handle Step 4 (Textarea)
            document.getElementById('step4Box').innerHTML = '<span id="step4Pending" class="text-sm">Pending</span>';
            const ocrTextarea = document.createElement('textarea');
            ocrTextarea.id = "ocrResult";
            ocrTextarea.rows = 3;
            ocrTextarea.readOnly = true;
            ocrTextarea.className = "w-full bg-gray-900 text-gray-200 text-2xl font-mono p-4 rounded-md border-gray-700";
            ocrTextarea.style = "display: none; min-height: 100px; resize: none;";
            document.getElementById('step4Box').appendChild(ocrTextarea);

            // Hide status message
            document.getElementById('statusMessage').classList.add('hidden');
        }

        // --- 3. Helper to show a spinner ---
        function showSpinner(elementId) {
            document.getElementById(elementId).innerHTML = '<div class="spinner"></div>';
        }

        // --- 4. Main Pipeline Function ---
        async function runPipeline() {
            if (!base64Image) {
                showStatus("Please upload an image first.", "danger");
                return;
            }

            // --- A. Set up UI for loading ---
            showStatus("Processing... This may take a moment.", "primary");
            showSpinner('step1Box');
            showSpinner('step2Box');
            showSpinner('step3Box');
            showSpinner('step4Box');
            document.getElementById('runButton').disabled = true;

            // --- B. Call the Python API ---
            try {
                const response = await fetch('http://127.0.0.1:5000/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: base64Image }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Server error: ${response.status}`);
                }

                const data = await response.json();
                
                // --- C. Populate UI with results ---
                
                // Step 1: Grayscale
                if (data.step_1_gray) {
                    document.getElementById('step1Box').innerHTML = `<img src="data:image/png;base64,${data.step_1_gray}" alt="Grayscale" />`;
                } else {
                    document.getElementById('step1Box').innerHTML = '<span class="text-sm text-red-400">Failed</span>';
                }

                // Step 3: Localized Plate (YOLO)
                if (data.step_3_localized) {
                    document.getElementById('step3Box').innerHTML = `<img src="data:image/png;base64,${data.step_3_localized}" alt="Localized Plate" />`;
                } else {
                    document.getElementById('step3Box').innerHTML = '<span class="text-sm text-yellow-400">No Plate Found</span>';
                }

                // Step 2: OCR Pre-processing (Warped Plate)
                if (data.step_2_ocr_prepped) {
                    document.getElementById('step2Box').innerHTML = `<img src="data:image/png;base64,${data.step_2_ocr_prepped}" alt="OCR Pre-processed" />`;
                } else {
                    document.getElementById('step2Box').innerHTML = '<span class="text-sm text-yellow-400">No Plate Found</span>';
                }

                // Step 4: OCR Text
                if (data.step_4_ocr_text) {
                    // Hide the "Pending" text
                    const pendingSpan = document.getElementById('step4Pending');
                    if (pendingSpan) {
                        pendingSpan.style.display = 'none';
                    }
                    
                    // Show and populate the textarea
                    const ocrTextarea = document.getElementById('ocrResult');
                    ocrTextarea.value = data.step_4_ocr_text;
                    ocrTextarea.style.display = 'block';
                } else {
                    document.getElementById('step4Box').innerHTML = '<span class="text-sm text-red-400">Failed</span>';
                }

                showStatus("Pipeline finished successfully!", "success");

            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}. Is the Python server running?`, "danger");
                resetPipelineUI();
            } finally {
                document.getElementById('runButton').disabled = false;
            }
        }

        // --- 5. Show Status Message ---
        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'btn-primary', 'btn-success', 'btn-danger');

            if (type === 'primary') {
                statusMessage.classList.add('btn-primary');
            } else if (type === 'success') {
                statusMessage.classList.add('btn-success');
            } else if (type === 'danger') {
                statusMessage.classList.add('btn-danger');
            }
        }
    </script>
</body>
</html>